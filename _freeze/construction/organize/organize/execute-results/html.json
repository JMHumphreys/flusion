{
  "hash": "4c295c5b6e45cec828d3e43ec5c5ce84",
  "result": {
    "markdown": "---\ntitle: \"Data Organization\"\ndescription: \"Formatting data as list() objects and DataStacks for model input.\"\nformat:\n  html:\n    df-print: kable\n    code-fold: show\n    code-summary: \"Hide code\"\n    code-overflow: wrap\n    toc-title: Page Contents\n    toc: true\n    toc-depth: 2\n    toc-location: right\n    number-sections: false\n    html-math-method: katex\n    css: styles.css\n    theme: flatly\n    smooth-scroll: true\neditor_options: \n  chunk_output_type: console\n---\n\n```{=html}\n<style type=\"text/css\">\n\nbody, td {\n   font-size: 13pt;\n}\ncode.r{\n  font-size: 9pt;\n}\npre {\n  font-size: 11pt\n}\n</style>\n```\n\n# Overview\n\nOrganizing data for a three-part joint model can be complex. This script walks through *DataStack* construction where a DataStack is a list object that holds all data for model fitting. Because this is a three-part model, DataStacks will be created for each submodel (e.g., an ILI submodel, a NREVSS submodel, and a HHS submodel) then the three submodel DataStacks will be combined as a *joint_stack*. As part of DataStack construction, a three-part response/dependent variable will be specified as a three-column matrix.\n\n**Note:** This script requires that data [**Preprocessing**](https://jmhumphreys.github.io/flusion/construction/preprocessing/preprocessing.html) has already been completed and all **Preprocessing** objects are available in the working environment.\n\n\n::: {.cell}\n\n:::\n\n\n## ILI DataStack\n \nThe ILI model will occupy the base level of the joint model and pass *information* to both the middle level submodel (NREVSS) and the top level HHS submodel.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nilinet_full <- as.data.frame(ilinet_full) %>%\n  mutate(y_ili = unweighted.s, #Response variable, logit transformed percentage of influenza-like illnesses.\n         l.pop.ili = log(population), #log population size\n         Region.1.ili = Region, #an identifier for each location (i.e., States and Territories)\n         Region.2.ili = Region,\n         Region.3.ili = Region,\n         Region.4.ili = Region,\n         ts_week.1.ili = ts_week, #integer time step for epiweeks 2010 to 2023-epiweek-22\n         ts_week.2.ili = ts_week,\n         ts_week.3.ili = ts_week,\n         ts_week.4.ili = ts_week,\n         state.ili = abbreviation, #State abbreviations\n         year.ili = as.integer(as.factor(year)), #integer time step for years\n         year.ili.1 = as.integer(as.factor(year)),\n         year.ili.2 = as.integer(as.factor(year)),\n         year.ili.3 = as.integer(as.factor(year)),\n         source = 1) #just an ID to identify ILI data\n\n\n\nili.lst = list(list(intercept1 = rep(1, dim(ilinet_full)[1])), #custom intercept\n          list(l.pop.ili = ilinet_full[,\"l.pop.ili\"],  #log-population              \n               year.ili = ilinet_full[,\"year.ili\"],\n               en_est.s = ilinet_full[,\"en_est.s\"], #amplitude of temporal trend in FluSurv cases\n               year.ili.1 = ilinet_full[,\"year.ili.1\"],\n               year.ili.2 = ilinet_full[,\"year.ili.2\"],\n               year.ili.3 = ilinet_full[,\"year.ili.3\"],\n               ts_week = ilinet_full[,\"ts_week.1.ili\"],\n               ts_week.fs = ilinet_full[,\"ts_week.1.ili\"],\n               ts_week.iid = ilinet_full[,\"ts_week.1.ili\"],\n               ts_week.1.ili = ilinet_full[,\"ts_week.1.ili\"],\n               ts_week.2.ili = ilinet_full[,\"ts_week.2.ili\"],\n               ts_week.3.ili = ilinet_full[,\"ts_week.3.ili\"],\n               Region = ilinet_full[,\"Region.1.ili\"],\n               Region.1 = ilinet_full[,\"Region.1.ili\"],\n               Region.2 = ilinet_full[,\"Region.1.ili\"],\n               Region.cross = ilinet_full[,\"Region.1.ili\"],\n               Region.1.ili = ilinet_full[,\"Region.1.ili\"],\n               Region.2.ili = ilinet_full[,\"Region.2.ili\"],\n               Region.3.ili = ilinet_full[,\"Region.3.ili\"],\n               Region.4.ili = ilinet_full[,\"Region.4.ili\"],\n               st_int.ili = ilinet_full[,\"st_int\"], #State-Time interactions\n               state.ili = ilinet_full[,\"state.ili\"],\n               dsource = ilinet_full[,\"source\"]))\n\n# The ILI DataStack\nili.stk = inla.stack(data = list(Y = cbind(ilinet_full$y_ili, NA, NA)), #base level response in 1st slot, NAs are placeholders for other two\n                                      A = list(1,1),  #optional matrix object, not used in this analysis     \n                                effects = ili.lst,    # list object created above with indices and variables   \n                                    tag = \"ili\")      #arbitrary name/label to pull data later\n```\n:::\n\n\n## NREVSS Set\n\nSimilar to ILI DataStack above, creating one for the NREVSS submodel. Note that some variable names are the same as in the ILI DataStack (e.g., Region and st_int) BUT some are specific to this DataStack with a *.nv* designation: If a variable name is included in the joint model formula, it can only contribute to the submodels that also have it. This provides control such that some variables may be specific to one submodel or one DataStack, whereas other variables may be applicable to all submodels concurrently.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnrevss_full <- as.data.frame(nrevss_full) %>%\n  mutate(y_nrvs = Apos.s, #confirmed positive influenza A, logit transformed percentage\n         l.pop.nv = log(population),\n         Region.1.nv = Region,\n         Region.2.nv = Region,\n         Region.3.nv = Region,\n         Region.4.nv = Region,\n         ts_week.1.nv = ts_week,\n         ts_week.2.nv = ts_week,\n         ts_week.3.nv = ts_week,\n         ts_week.4.nv = ts_week,\n         state.nv = abbreviation,\n         year.nv = as.integer(as.factor(year)),\n         year.nv.1 = as.integer(as.factor(year)),\n         year.nv.2 = as.integer(as.factor(year)),\n         year.nv.3 = as.integer(as.factor(year)),\n         source = 2)\n\nnv.lst = list(list(intercept2 = rep(1, dim(nrevss_full)[1])), # custom intercept\n          list(l.pop.nv = nrevss_full[,\"l.pop.nv\"], \n               en_est.s = nrevss_full[,\"en_est.s\"],\n               year.nv = nrevss_full[,\"year.nv\"],\n               year.nv.1 = nrevss_full[,\"year.nv.1\"],\n               year.nv.2 = nrevss_full[,\"year.nv.2\"],\n               year.nv.3 = nrevss_full[,\"year.nv.3\"],\n               ts_week = nrevss_full[,\"ts_week.1.nv\"],\n               ts_week.fs = nrevss_full[,\"ts_week.1.nv\"],\n               ts_week.iid = nrevss_full[,\"ts_week.1.nv\"],\n               ts_week.1.nv = nrevss_full[,\"ts_week.1.nv\"],\n               ts_week.2.nv = nrevss_full[,\"ts_week.2.nv\"],\n               ts_week.3.nv = nrevss_full[,\"ts_week.3.nv\"],\n               Region = nrevss_full[,\"Region.1.nv\"],\n               Region.1 = nrevss_full[,\"Region.1.nv\"],\n               Region.2 = nrevss_full[,\"Region.1.nv\"],\n               Region.cross = nrevss_full[,\"Region.1.nv\"],\n               Region.1.nv = nrevss_full[,\"Region.1.nv\"],\n               Region.2.nv = nrevss_full[,\"Region.2.nv\"],\n               Region.3.nv = nrevss_full[,\"Region.3.nv\"],\n               Region.4.nv = nrevss_full[,\"Region.4.nv\"],\n               st_int = nrevss_full[,\"st_int\"],\n               st_int.nv = nrevss_full[,\"st_int\"],\n               state.nv = nrevss_full[,\"state.nv\"],\n               dsource = nrevss_full[,\"source\"]))\n\n\n#NREVSS DataStack\nnv.stk = inla.stack(data = list(Y = cbind(NA, nrevss_full$y_nrvs, NA)), #NA in the first and last columns (for ILI and HHS responses)\n                                      A = list(1,1),       \n                                effects = nv.lst,        \n                                    tag = \"nrvs\")\n```\n:::\n\n\n## HHS Set\n\nMuch the same as the ILI and NREVVS DataStacks.\n\n::: {.cell}\n\n```{.r .cell-code}\nflu_HHS_full <- as.data.frame(flu_HHS_full) %>%\n  mutate(y_hhs = log(hosp_inc+0.0001), #log hospital incidence (response variable)\n         l.pop.hhs = log(population),\n         Region.1.hhs = Region,\n         Region.2.hhs = Region,\n         Region.3.hhs = Region,\n         Region.4.hhs = Region,\n         ts_week.1.hhs = ts_week,\n         ts_week.2.hhs = ts_week,\n         ts_week.3.hhs = ts_week,\n         ts_week.4.hhs = ts_week,\n         state.hhs = abbreviation,\n         year.hhs = as.integer(as.factor(year)),\n         year.hhs.1 = as.integer(as.factor(year)),\n         year.hhs.2 = as.integer(as.factor(year)),\n         year.hhs.3 = as.integer(as.factor(year)),\n         source = 3)\n\nhhs.lst = list(list(intercept3 = rep(1, dim(flu_HHS_full)[1])), \n          list(l.pop.hhs = flu_HHS_full[,\"l.pop.hhs\"], \n               en_est.s = flu_HHS_full[,\"en_est.s\"],\n               year.hhs = flu_HHS_full[,\"year.hhs\"],\n               year.hhs.1 = flu_HHS_full[,\"year.hhs\"],\n               year.hhs.2 = flu_HHS_full[,\"year.hhs\"],\n               year.hhs.3 = flu_HHS_full[,\"year.hhs\"],\n               ts_week.fs = flu_HHS_full[,\"ts_week.1.hhs\"],\n               ts_week.c = flu_HHS_full[,\"ts_week.1.hhs\"],\n               ts_week.iid.c = flu_HHS_full[,\"ts_week.1.hhs\"],\n               ts_week.1.hhs = flu_HHS_full[,\"ts_week.1.hhs\"],\n               ts_week.2.hhs = flu_HHS_full[,\"ts_week.2.hhs\"],\n               ts_week.3.hhs = flu_HHS_full[,\"ts_week.3.hhs\"],\n               Region = flu_HHS_full[,\"Region.1.hhs\"],\n               Region.c = flu_HHS_full[,\"Region.1.hhs\"],\n               Region.1.c = flu_HHS_full[,\"Region.1.hhs\"],\n               Region.2.c = flu_HHS_full[,\"Region.1.hhs\"],\n               Region.1.hhs = flu_HHS_full[,\"Region.1.hhs\"],\n               Region.2.hhs = flu_HHS_full[,\"Region.2.hhs\"],\n               Region.3.hhs = flu_HHS_full[,\"Region.3.hhs\"],\n               Region.4.hhs = flu_HHS_full[,\"Region.4.hhs\"],\n               state.hhs = flu_HHS_full[,\"state.hhs\"],\n               st_int.c = flu_HHS_full[,\"st_int\"],\n               dsource = flu_HHS_full[,\"source\"]))\n\n# HHS DataStack  \nhhs.stk = inla.stack(data = list(Y = cbind(NA, NA, flu_HHS_full$y_hhs)), #NAs for ILI and NREVESS responses, HHS in 3rd spot\n                                      A = list(1,1),       \n                                effects = hhs.lst,        \n                                    tag = \"hhs\")   \n```\n:::\n\n\n## Join Datastacks\n\nJoining all three above DataStacks to a common object, joint DataStack. This is all the data needed for running the model.  \n\n::: {.cell}\n\n```{.r .cell-code}\njoint_stack <- inla.stack(ili.stk, nv.stk, hhs.stk)\n```\n:::\n\n::: {.cell}\n\n:::\n",
    "supporting": [
      "organize_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}